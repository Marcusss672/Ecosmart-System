<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin Registration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <style>
      .admin-header {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .admin-name {
        font-weight: bold;
        color: #495057;
        font-size: 18px;
      }
      .form-container {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      }
      body {
        background-color: #f5f6fa;
      }
      .btn-primary {
        background-color: #4CAF50;
        border-color: #4CAF50;
      }
      .btn-primary:hover {
        background-color: #45a049;
        border-color: #45a049;
      }
    </style>
  </head>
  <body>

    <div class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div class="form-container">
            <div class="admin-header text-center">
              
            
            <form id="MainForm">
              <h2 class="mb-4 text-center">Register New Admin</h2>
              
              <div class="form-floating mb-3">
                <input type="email" class="form-control" id="emailInp" placeholder="name@example.com" required>
                <label for="emailInp">Email address</label>
              </div>
              
              <div class="form-floating mb-3">
                <input type="password" class="form-control" id="passwordInp" placeholder="Password" required minlength="6">
                <label for="passwordInp">Password</label>
              </div>
              
              <div class="form-floating mb-3">
                <input type="password" class="form-control" id="confirmPasswordInp" placeholder="Confirm Password" required minlength="6">
                <label for="confirmPasswordInp">Confirm Password</label>
              </div>
              
              <div class="form-floating mb-3">
                <input type="text" class="form-control" id="fnameInp" placeholder="First Name" required>
                <label for="fnameInp">First Name</label>
              </div>
              
              <div class="form-floating mb-3">
                <input type="text" class="form-control" id="lnameInp" placeholder="Last Name" required>
                <label for="lnameInp">Last Name</label>
              </div>

              <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="login.html" class="btn btn-secondary me-md-2">Sign In</a>
                <button type="submit" class="btn btn-primary" id="registerBtn">Create New Admin</button>
              </div>
              
              <div id="message" class="mt-3"></div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
        import { getDatabase, set, ref, get } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-analytics.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyAn2WHhyPfyYV0rj5oZRo6MQK5HDbucIbo",
          authDomain: "queueing-8976a.firebaseapp.com",
          databaseURL: "https://queueing-8976a-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "queueing-8976a",
          storageBucket: "queueing-8976a.firebasestorage.app",
          messagingSenderId: "10213448291",
          appId: "1:10213448291:web:2d07230ebe2fe2a9f0f656",
          measurementId: "G-0YVVS8SY1V"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase();
        const auth = getAuth(app);

        // Get form elements
        let EmailInp = document.getElementById('emailInp');
        let PassInp = document.getElementById('passwordInp');
        let ConfirmPassInp = document.getElementById('confirmPasswordInp');
        let FnameInp = document.getElementById('fnameInp');
        let LnameInp = document.getElementById('lnameInp');
        let MainForm = document.getElementById('MainForm');
        let RegisterBtn = document.getElementById('registerBtn');
        let MessageDiv = document.getElementById('message');

        // Show message function
        function showMessage(message, type = 'danger') {
            MessageDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
        }

        // Register Admin function
        let RegisterUser = async (evt) => {
            evt.preventDefault();
            
            // Clear previous messages
            MessageDiv.innerHTML = '';
            
            // Get form values
            const email = EmailInp.value.trim();
            const password = PassInp.value;
            const confirmPassword = ConfirmPassInp.value;
            const firstName = FnameInp.value.trim();
            const lastName = LnameInp.value.trim();
            
            // Validate form
            if (!email || !password || !confirmPassword || !firstName || !lastName) {
                showMessage('Please fill in all fields.');
                return;
            }
            
            if (password !== confirmPassword) {
                showMessage('Passwords do not match.');
                return;
            }
            
            if (password.length < 6) {
                showMessage('Password must be at least 6 characters long.');
                return;
            }
            
            // Disable button during registration
            RegisterBtn.disabled = true;
            RegisterBtn.textContent = 'Creating Admin...';
            
            try {
                // Create user with email and password
                const credentials = await createUserWithEmailAndPassword(auth, email, password);
                const user = credentials.user;
                
                // Update user profile with display name
                await updateProfile(user, {
                    displayName: `${firstName} ${lastName}`
                });
                
                // Store admin data in database
                await set(ref(db, 'admins/' + user.uid), {
                    firstName: firstName,
                    lastName: lastName,
                    email: email,
                    name: `${firstName} ${lastName}`,
                    displayName: `${firstName} ${lastName}`,
                    role: 'admin',
                    createdAt: new Date().toISOString(),
                    isActive: true
                });
                
                // Also store in UsersAuthList for compatibility
                await set(ref(db, 'UsersAuthList/' + user.uid), {
                    firstname: firstName,
                    lastname: lastName,
                    email: email,
                    role: 'admin'
                });
                
                // Store admin data in localStorage (consistent format)
                const adminData = {
                    firstName: firstName,
                    lastName: lastName,
                    email: email,
                    name: `${firstName} ${lastName}`,
                    displayName: `${firstName} ${lastName}`,
                    role: 'admin'
                };
                
                localStorage.setItem('adminId', user.uid);
                localStorage.setItem('adminData', JSON.stringify(adminData));
                
                // Also store in sessionStorage for session management
                sessionStorage.setItem("user-creds", JSON.stringify({
                    uid: user.uid,
                    email: email
                }));
                sessionStorage.setItem("user-info", JSON.stringify(adminData));
                
                console.log('Admin data stored:', adminData);
                console.log('LocalStorage adminData:', localStorage.getItem('adminData'));
                
                // Show success message
                showMessage('Admin registered successfully! Redirecting to dashboard...', 'success');
                
                // Reset form
                MainForm.reset();
                
                // Redirect to admin homepage after successful registration
                setTimeout(() => {
                    window.location.href = 'adminhomepage.html';
                }, 2000);
                
            } catch (error) {
                console.error('Registration error:', error);
                let errorMessage = 'Registration failed. Please try again.';
                
                // Handle specific error codes
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'This email is already registered.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Please enter a valid email address.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Password should be at least 6 characters.';
                        break;
                }
                
                showMessage(errorMessage);
            } finally {
                // Re-enable button
                RegisterBtn.disabled = false;
                RegisterBtn.textContent = 'Create New Admin';
            }
        }

        // Add event listener
        MainForm.addEventListener('submit', RegisterUser);
    </script>
  </body>
</html>